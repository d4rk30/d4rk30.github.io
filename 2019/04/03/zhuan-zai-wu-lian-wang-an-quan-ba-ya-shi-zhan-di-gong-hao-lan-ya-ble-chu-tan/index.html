<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.nohacker.me","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.18.1","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="备忘录">
<meta property="og:type" content="article">
<meta property="og:title" content="【转载】物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探">
<meta property="og:url" content="https://www.nohacker.me/2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/index.html">
<meta property="og:site_name" content="黑客与产品">
<meta property="og:description" content="备忘录">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-e3e1ebbc553577a53739601cf8600a8cd575ca3b.png">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-3f873d2f0fb9c124fce3bc01664d9093e3da7310.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5884024f3eb2008f217001824a9d150b976ac664.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-7d2553356af5ce0ba807cee27f3fc7304fcdae67.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-30d3ffdedf9dc35792e2233a7967b9c5188d1e44.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-b24fe5a6f04dae3a3807c03a89154682cf259771.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-744a77d9503fce7d5157148aa29a9530e86ce625.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-ec79aa87b61e0ef442d36a38a42675a3303b4d06.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-f731d1b763bb446b84dc69dd1756d6631cbc6920.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5fafcc3d2c12101d53c15654b0618ba975a946eb.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-d1ed770f7145891fa232fcc1cf85e3f2a2fd74e9.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5d9700eed90a8119eeeb134a83ce0ea2f5ebe647.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-25ce2cbc5196e2d397c9485c03c7ccc57b5c8bc9.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-d2bcb420fabeeea93f6edbe640af213364a0b7ed.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5b756ef883147e4434ca202d10841a4232fe4114.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-9c0796f355a0b3c4eac9dfa60452d0b774b4f36d.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5e0e07baf3b8b4279c445ee88431e4fad31814c3.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-b5f62057982f6777c01b1dd776b4226c7189c9bf.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-644afb4717643723d463f2ee9db47acdf0c43852.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-35556fa64838b6ac201e212817f10760b2f9243e.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-a797fe2fc11e7bbd096f447b391627524ecbea86.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-43c611880386febef0276bcd77eef2d42d951b89.jpeg">
<meta property="og:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-4e131dca1cfcc3b82b42c1542175ae1a8fb29c95.jpeg">
<meta property="article:published_time" content="2019-04-03T08:22:53.000Z">
<meta property="article:modified_time" content="2023-12-07T11:04:36.726Z">
<meta property="article:author" content="d4rk30">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-e3e1ebbc553577a53739601cf8600a8cd575ca3b.png">


<link rel="canonical" href="https://www.nohacker.me/2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.nohacker.me/2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/","path":"2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/","title":"【转载】物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【转载】物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探 | 黑客与产品</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">黑客与产品</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">站在巨人的肩上思考🤔️</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section">归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-BLE%E6%A6%82%E8%BF%B0"><span class="nav-text">0x01 BLE概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-BLE-%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%80%BB%E8%A7%88"><span class="nav-text">1. BLE 协议栈总览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-GAP%EF%BC%8D%E9%80%9A%E7%94%A8%E8%AE%BF%E9%97%AE%E8%A7%84%E8%8C%83"><span class="nav-text">2. GAP－通用访问规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-GATT%EF%BC%8D%E9%80%9A%E7%94%A8%E5%B1%9E%E6%80%A7%E5%8D%8F%E8%AE%AE"><span class="nav-text">3. GATT－通用属性协议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-BLE%E5%97%85%E6%8E%A2"><span class="nav-text">0x02 BLE嗅探</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E4%BC%AA%E9%80%A0BLE%E9%80%9A%E4%BF%A1"><span class="nav-text">0x03 伪造BLE通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E5%88%86%E6%9E%90BLE%E7%A7%81%E6%9C%89%E6%95%B0%E6%8D%AE%E5%8D%8F%E8%AE%AE%EF%BC%88%E7%81%AF%E6%B3%A1%E3%80%81%E8%B7%B3%E8%9B%8B%E3%80%81%E5%B0%8F%E7%B1%B3%E6%89%8B%E7%8E%AF%EF%BC%89"><span class="nav-text">0x04 分析BLE私有数据协议（灯泡、跳蛋、小米手环）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-YeeLight-2-%E4%BB%A3%E8%93%9D%E7%89%99%E7%81%AF%E6%B3%A1"><span class="nav-text">1. YeeLight 2 代蓝牙灯泡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%B0%8F%E7%88%B1%E7%88%B1%E6%99%BA%E8%83%BD%E8%B7%B3%E8%9B%8B%EF%BC%88%E8%BF%99%E4%B8%AA%E7%9C%9F%E4%B8%8D%E6%98%AF%E6%88%91%E7%9A%84%EF%BC%8C%E6%9F%90%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4%E5%80%9F%E7%BB%99%E6%88%91%E7%A0%94%E7%A9%B6%E7%9A%84%EF%BC%89"><span class="nav-text">2. 小爱爱智能跳蛋（这个真不是我的，某个小伙伴借给我研究的）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%B0%8F%E7%B1%B3%E6%89%8B%E7%8E%AF"><span class="nav-text">3. 小米手环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%95%AA%E5%A4%96%E7%AF%87%EF%BC%9A%E5%B0%8F%E7%B1%B3%E6%89%8B%E7%8E%AF%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90"><span class="nav-text">4. 番外篇：小米手环认证机制分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-%E7%BB%93%E8%AF%AD"><span class="nav-text">0x05 结语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">0x06 参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">d4rk30</p>
  <div class="site-description" itemprop="description">站在巨人的肩上思考🤔️</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.nohacker.me/2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="d4rk30">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黑客与产品">
      <meta itemprop="description" content="站在巨人的肩上思考🤔️">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="【转载】物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探 | 黑客与产品">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【转载】物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-03 16:22:53" itemprop="dateCreated datePublished" datetime="2019-04-03T16:22:53+08:00">2019-04-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-07 19:04:36" itemprop="dateModified" datetime="2023-12-07T19:04:36+08:00">2023-12-07</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-e3e1ebbc553577a53739601cf8600a8cd575ca3b.png" alt="img"></p>
<blockquote>
<p>备忘录</p>
</blockquote>
<span id="more"></span>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>因为自己曾DIY过所谓的“智能硬件”，学习过程中除了接触各种芯片、传感器、电路知识外，也拆了不少设备分析其设计思想学以致用。再后来又接触了如：Wi-Fi、ZigBee、Bluetooth、NFC、IR、普通射频甚至音频等通信技术，才发现空气中那些形形色色的边界，才是整个物联安全的关键。</p>
<p>今天的内容是我在乌云内部做的技术分享，也是我以前对低功耗蓝牙技术的一些接触，整理后决定对社区公布。一来可以让社区对神秘的蓝牙技术破冰；二来也是抛砖引玉，希望能看到更多有趣的案例；三来比起那些华丽丽的show，我更喜欢分享一些实际的内容。</p>
<p>本次的研究目标是蓝牙4.0中的低功耗技术（<strong>Bluetooth Low Energy</strong>）简称“<strong>BLE</strong>”，需要注意一些技术规范容易与经典蓝牙搞混。</p>
<p>正文开始前再看一段新闻报道吧，感受下蓝牙对当前以及未来在我们生活中的影响力：</p>
<blockquote>
<p>2015年8月18日-19日，蓝牙技术联盟(Bluetooth Special Interest Group，简称SIG)在上海举办2015蓝牙亚洲大会。蓝牙技术联盟执行总监Mark Powell在会上指出，目前蓝牙已经成为全球使用量最大的无线技术。目前，蓝设备的年出货量在过去15年内增加了1000倍，已经达到了30亿的水平，在未来的4-5年内还将增加到50亿。</p>
</blockquote>
<h2 id="0x01-BLE概述"><a href="#0x01-BLE概述" class="headerlink" title="0x01 BLE概述"></a>0x01 BLE概述</h2><p>这里本应该先讲解蓝牙与低功耗蓝牙的基础知识，但网上资料充足，所以各位还是从文章最后的参考资料中学习吧。乌云上也有白帽做了部分科普 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/k1two2/p/5018212.html">Bluetooth Low Energy 嗅探</a> 感谢他的分享。所以我只讲基础知识中的关键内容，然后多放些大家喜闻乐见的实战案例。</p>
<h3 id="1-BLE-协议栈总览"><a href="#1-BLE-协议栈总览" class="headerlink" title="1. BLE 协议栈总览"></a>1. BLE 协议栈总览</h3><p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-3f873d2f0fb9c124fce3bc01664d9093e3da7310.jpeg" alt="img"></p>
<p>这个协议栈非常复杂，想基础化了解BLE协议基础的，就可以参考最新蓝牙4.2的官方文档 <a target="_blank" rel="noopener" href="https://www.bluetooth.org/en-us/specification/adopted-specifications">Bluetooth® Core Specification 4.2</a>，我只简单的提取我理解的关键部分。</p>
<h3 id="2-GAP－通用访问规范"><a href="#2-GAP－通用访问规范" class="headerlink" title="2. GAP－通用访问规范"></a>2. GAP－通用访问规范</h3><p>BLE设备的链接与加密、签名协议的协商在这一层，比如BLE的两种安全模式，首先是Security Mode 1，这个模式主要负责“加密”，它含有三个安全等级：</p>
<ul>
<li>Level 1 无认证无加密，链路默认模式。我手头有的设备默认都是这个等级，不靠谱…</li>
<li>Level 2 带加密的未认证配对</li>
<li>Level 3 带加密的认证配对</li>
</ul>
<p>其次是Security Mode 2，这个模式主要负责“签名”，它含有两个安全等级：</p>
<ul>
<li>Level 1：带数据签名的未认证配对</li>
<li>Level 2：带数据签名的认证配对</li>
</ul>
<blockquote>
<p>PS：以上都是书本知识，具体可以参照蓝牙4.2官方文档内对BLE安全的解说部分，注意不要跟蓝牙混淆。</p>
</blockquote>
<h3 id="3-GATT－通用属性协议"><a href="#3-GATT－通用属性协议" class="headerlink" title="3. GATT－通用属性协议"></a>3. GATT－通用属性协议</h3><p>GATT负责两个BLE设备间通信的数据交互，是对功能数据最为重要的部分，这篇文章的核心也在这里。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5884024f3eb2008f217001824a9d150b976ac664.jpeg" alt="img"></p>
<p>如图，GATT中的三个要素Profile、Service、Characteristic以及他们的层级关系，值得注意的是，Profile其实是SIG蓝牙技术联盟给一些同范畴内的Service打包后的集合，比如电池、心率、血压等，可以参照官方 <a target="_blank" rel="noopener" href="https://developer.bluetooth.org/TechnologyOverview/Pages/Profiles.aspx#GATT">Profiles Overview</a> 所以Profile对我们的分析并无大用，不用放在心上。</p>
<p>Service和Characteristic是比较重要的，Service可以理解为PHP中的“类”，功能对象的集合。Characteristic可以理解为PHP的“函数”，是GATT中具体的功能对象，每个Service都可以包含一个或多个Characteristic。</p>
<p>为什么说GATT很重要？因为理解了它，就已经能够分析或是“黑掉”一些BLE设备了。比如小米手环在国内某个硬件安全会议上被做过一个攻击演示，使用Lightblue连接到手环后，只要用给其中一个Characteristic写入1，就可以让手环震动起来，大家很惊讶但有不知所以然。我来用官方注册的Characteristic角度解释一下：</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-7d2553356af5ce0ba807cee27f3fc7304fcdae67.jpeg" alt="img"></p>
<p>那个FEE7就是一个私有Service的UUID，里面的0xFE**就是私有Characteristic的UUID，在往下面这个Immediate Alert 显示出了名称，代表其不是小米私有的Service，而是官方公开定义的Service，我们点击进入这个 Characteristic。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-30d3ffdedf9dc35792e2233a7967b9c5188d1e44.jpeg" alt="img"></p>
<p>看到了这个 Characteristic 的UUID 2A06，然后我们去蓝牙官网定义的列表 <a target="_blank" rel="noopener" href="https://www.bluetooth.com/specifications/gatt/characteristics/">Characteristics</a> 搜索 2A06，进入Characteristic的详情页面。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-b24fe5a6f04dae3a3807c03a89154682cf259771.jpeg" alt="img"></p>
<p>该 Characteristic 操作定义非常明确了：</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td align="left">无警告</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">温和的警告</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">强烈的警告</td>
</tr>
<tr>
<td align="left">3~255</td>
<td align="left">预留</td>
</tr>
</tbody></table>
<p>所以你向UUID为 0x2A06 的 Characteristic 写入1的时候，小米手环会变会震动。其实你还能输入2，这个快感比1更酸爽～哦呦、别、别停…… 这是一个简单的GATT例子，不知各位是否明白，现在你可以安装个LightBlue链接你身边的BLE设备，看看能否发现一些问题了呢？</p>
<p>小知识：GATT中的UUID有16bit和128bit两种，官网看到那些都是16bit的（其实真正的通信都是128bit的，官方UUID在第一段数据中可以识别）。官方认证过的UUID是要花银子的，但你可以免费使用，保证软硬件的相互理解。相反，私有UUID只有你自己的软硬件才能够理解，要弄明白功能就得技术性分析，也就是我后面要做的事情。</p>
<h2 id="0x02-BLE嗅探"><a href="#0x02-BLE嗅探" class="headerlink" title="0x02 BLE嗅探"></a>0x02 BLE嗅探</h2><p>在遇到私有Service或Characteristic的时候，就要通过app逆向或嗅探蓝牙通信来分析了。说到蓝牙嗅探，大家第一想到的肯定是神器 Ubertooth One，精致的硬件＋配套的软件变成了物联网黑客强大的帮手，缺点大家有所体会——昂贵。在自己做了一些简单的BLE设备研究后，了解到其实有更廉价的方案可供使用，这就是蓝牙芯片厂所提供的BLE USB Dongle。</p>
<blockquote>
<p>BLE USB Dongle，蓝牙芯片厂商为了方便开发者能够方便的调试蓝牙产品通信，就将这些蓝牙芯片集成为USB模块，可进行方便的蓝牙透传测试。而你可以烧入Sniffer固件，就可以利用这个设备分析附近的蓝牙通信，然后将数据通过USB串口输出到计算机上。</p>
</blockquote>
<p>代表性的芯片有：</p>
<ul>
<li>德州仪器（TI）的CC254x系列，配有官方的Sniffer程序，非常强大</li>
</ul>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-744a77d9503fce7d5157148aa29a9530e86ce625.jpeg" alt="img"></p>
<ul>
<li>北欧（Nordic）的NRF51822，串口输出到计算机后，通过pipe方式使用Wireshark分析</li>
</ul>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-ec79aa87b61e0ef442d36a38a42675a3303b4d06.jpeg" alt="img"></p>
<p>我个人喜欢后者，因为我觉得这个数字对于我来说很吉利…吉利？…好吧，我就索性放弃Ubertooth One这款神器，给大家看看USB Dongle的其他玩法：）另外注意，NRF51822是一块单模（Bluetooth Smart）芯片，只支持BLE。具体参考官方文档：<a target="_blank" rel="noopener" href="https://www.nordicsemi.com/eng/nordic/download_resource/31919/6/98796976">nRF Sniffer User Guide v1.1</a></p>
<p>配置好环境之后就可以对附近的设备通信进行抓取了，我先来验证一下书本知识。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-f731d1b763bb446b84dc69dd1756d6631cbc6920.jpeg" alt="img"></p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5fafcc3d2c12101d53c15654b0618ba975a946eb.jpeg" alt="img"></p>
<p>这是BLE设备建立链接前主设备发给从设备的 CHANNEL_MAP_REQ 信息，用来告知BLE这40个信道哪些已经被占用，哪些可以使用。从中我们可以看到BLE频率起始为2402MHz，结束为2480MHz，信道间距2MHz，有3个不可使用的广播信道37、38、39（频段的起始、结尾与中心各设置一个广播频道，合理），这些都与书本知识吻合。</p>
<p>然后我们选择一个BLE设备的MAC地址进行Sniffer，<strong>注意一定要在设备连接前就指定mac监听</strong>。监听后随便发起什么通过蓝牙信号的操作，我们就抓取到了第一个BLE数据包。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-d1ed770f7145891fa232fcc1cf85e3f2a2fd74e9.jpeg" alt="img"></p>
<p>很激动有木有？现在抓取BLE通信就犹如抓取网络通信一样便捷了，连复杂的跳频都先不用去考虑了撒。接下来再看最下面 Bluetooth Attribute Protocol 就是关键的 BLE 操作通信内容，那个value是该产品的私有通信协议。虽然现在看不懂意思，但并非是加密所致，因为我前面有提到，我手里的设备安全链路全是Security Mode 1 默认的Level 1这个级别…那私有协议如何分析？别急，后面的实战部分我会介绍我的思路。</p>
<h2 id="0x03-伪造BLE通信"><a href="#0x03-伪造BLE通信" class="headerlink" title="0x03 伪造BLE通信"></a>0x03 伪造BLE通信</h2><p>现在可以分析BLE通信了，接下来还要知道如何发送BLE信号，让对方设备执行我们期望的操作。其实要达成这个目标BLE USB Dongle或蓝牙开发版就可以实现，但为了今后更多无线通信测试的便捷性，我还是准备打造一款软硬结合的平台。所以软件我使用Linux官方的蓝牙栈BlueZ（很多蓝牙攻击程序都是基于该蓝牙栈），硬件我则选择了CSR厂的CSR8510芯片蓝牙适配器。平台我用2代树莓派搭建，未来会支持蓝牙、RTL-SDR、ZigBee等常见无线通信协议，比那些装个kali2就叫“无线渗透”的设备可玩性多了些嘿嘿。</p>
<ul>
<li>CSR8510 蓝牙适配器</li>
<li>BlueZ 官方蓝牙协议栈</li>
<li>Raspberry2 平台</li>
</ul>
<p>目前蓝牙的设备塞在一起就是酱紫了。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5d9700eed90a8119eeeb134a83ce0ea2f5ebe647.jpeg" alt="img"></p>
<p>在这里，我们用Bluez自带的hcitool扫描下没开启广播的BLE设备，比如小米手环。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-25ce2cbc5196e2d397c9485c03c7ccc57b5c8bc9.jpeg" alt="img"></p>
<p>无处遁形。</p>
<p>在上一节BLE抓包后，我们得到的 Bluetooth Attribute Protocol 中的信息，就是发出BLE信号的关键部分：</p>
<ul>
<li><strong>OPcode</strong><br>操作：Read、Write还是Notify（写操作也不一定都是 write request 还有 write command，区别自己搜）</li>
<li><strong>Handle</strong><br>操作句柄，可以简单理解为 Characteristic 的基址，真正的通信地址</li>
<li><strong>Value</strong><br>设备间传输的数据真身。有了这几个信息，我们就可以调用BlueZ给设备发送修改后的信号了。</li>
</ul>
<h2 id="0x04-分析BLE私有数据协议（灯泡、跳蛋、小米手环）"><a href="#0x04-分析BLE私有数据协议（灯泡、跳蛋、小米手环）" class="headerlink" title="0x04 分析BLE私有数据协议（灯泡、跳蛋、小米手环）"></a>0x04 分析BLE私有数据协议（灯泡、跳蛋、小米手环）</h2><p>有了上面的理论基础，要开始实战了。我手头上只有蓝牙灯泡和小米手环，后来一个猥琐的朋友借我个跳蛋希望帮忙分析…</p>
<h3 id="1-YeeLight-2-代蓝牙灯泡"><a href="#1-YeeLight-2-代蓝牙灯泡" class="headerlink" title="1. YeeLight 2 代蓝牙灯泡"></a>1. YeeLight 2 代蓝牙灯泡</h3><p>首先这个灯泡我在分析前就敢肯定他是存在问题的，因为灯泡的操作逻辑不会过于复杂，无非是一开一关、变色等等，所以我就拿他来做“Hello world”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 抓包灯泡的开关灯动作的value</span><br><span class="line">2c2c2c3130302c2c2c2c2c2c2c2c2c2c2c2c（开）</span><br><span class="line">2c2c2c302c2c2c2c2c2c2c2c2c2c2c2c2c2c（关）</span><br></pre></td></tr></table></figure>

<p>看到差异了么？</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-d2bcb420fabeeea93f6edbe640af213364a0b7ed.jpeg" alt="img"></p>
<p>0x313030 &#x3D; 100 0x30 &#x3D; 0 从 4bytes 开始，就是该灯泡的亮度部分，100最亮，0没有亮度，也就是关。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2. 抓包灯泡的换颜色动作</span><br><span class="line"></span><br><span class="line">3235352c302c302c3130302c2c2c2c2c2c2c（红色）</span><br><span class="line">302c302c3235352c3130302c2c2c2c2c2c2c（蓝色）</span><br></pre></td></tr></table></figure>

<p>同上道理</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5b756ef883147e4434ca202d10841a4232fe4114.jpeg" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x3235352c302c30 = 255,0,0</span><br><span class="line">0x302c302c323535 = 0,0,255</span><br><span class="line">这就是RGB的颜色格式，很简单直接告破：）最后看下 Handle 0x0012，来源如图：</span><br></pre></td></tr></table></figure>

<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-9c0796f355a0b3c4eac9dfa60452d0b774b4f36d.jpeg" alt="img"></p>
<p>最后，简单的看下Bluez协议栈自带的gatttool工具的使用方法。</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-5e0e07baf3b8b4279c445ee88431e4fad31814c3.jpeg" alt="img"></p>
<p>通过抓包分析得知操控灯泡颜色的handle是0x0012，我读了下他的uuid为fff1，私有的。用char-write-cmd命令直接写入我们分析好的协议，灯泡变色，然后再读取之，数据确实成功写入。</p>
<h3 id="2-小爱爱智能跳蛋（这个真不是我的，某个小伙伴借给我研究的）"><a href="#2-小爱爱智能跳蛋（这个真不是我的，某个小伙伴借给我研究的）" class="headerlink" title="2. 小爱爱智能跳蛋（这个真不是我的，某个小伙伴借给我研究的）"></a>2. 小爱爱智能跳蛋（这个真不是我的，某个小伙伴借给我研究的）</h3><p>这个产品感觉逻辑也简单，就是网络远程发送震动指令到手机，手机在通过BLE链接设备进行你懂、我懂、他也懂的事情，羞～</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-b5f62057982f6777c01b1dd776b4226c7189c9bf.jpeg" alt="img"></p>
<p>这个跳蛋有三种模式：<strong>预定义节奏的震动、随着音乐翩翩起舞的震动还有一个体位交互震动</strong>，因为前两个没啥难度，基本抓到操作重放出来就OK了，最后这个模式比较卡哇伊，玩玩它咯。</p>
<p>与灯泡不同的是，进入体位模式后，Master会给Slave发送一个状态开启这个模式。所以你盲目的发送抓到的震动操作这个蛋是不震的，因为你要先让她进入状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">给 Handle 0x0013 发送 0x0811060f01010232 后，它就进入状态了。</span><br><span class="line">然后 0x3e ＝ 震动，0x7f ＝ 生理暴击（你狂按手机的时候就疯狂的震动）</span><br></pre></td></tr></table></figure>

<p>这个分析很简单，因为都是些开关类的操作没有太多实际的含义，所以无需解开数据，直接重放就可以，我做了个发送SOS急救信号的demo。</p>
<h3 id="3-小米手环"><a href="#3-小米手环" class="headerlink" title="3. 小米手环"></a>3. 小米手环</h3><p>小米手环是明星产品，对他的分析也充满了趣味与困难，因为从一开始我就遇到了一个认证机制，如果蓝牙链接后不写入一段特殊格式的数据，那你只能读少量信息不能对手环进行操作。我通过抓包分析GATT中的write操作，过程省略2万字，最终定位了一个向 Handle 0x0019 进行的write操作，该Characteristic返回了个Notify，然后手环就可以随意写指令了（如私有协议中的震动、LED颜色变化、开启实时步数监控等）。</p>
<p>不过认证怎么能叫PWN？<br>不过认证怎么能叫PWN？<br>不过认证怎么能叫PWN？</p>
<p>重要的事情说三遍。小米手环的认证数据分析好了，结构如下：</p>
<table>
<thead>
<tr>
<th>UID</th>
<th>性别</th>
<th>身高&amp;体重</th>
<th>昵称</th>
<th>类型</th>
<th>签名</th>
</tr>
</thead>
<tbody><tr>
<td>dcxxxx00</td>
<td>0100</td>
<td>af3a00</td>
<td>66656e67676f7500</td>
<td>0000</td>
<td>fe</td>
</tr>
</tbody></table>
<p>这个签名是最重要的部分，前面的数据都可以伪造，只要签名过了，手环就会允许你后续的写指令，才能做到真正的PWN。那这个签名是咋算出来的？请看番外篇。</p>
<h3 id="4-番外篇：小米手环认证机制分析"><a href="#4-番外篇：小米手环认证机制分析" class="headerlink" title="4. 番外篇：小米手环认证机制分析"></a>4. 番外篇：小米手环认证机制分析</h3><p>剑走偏锋，通过BlueZ得到了小米手环一个完整的私有协议UUID，然后去Github搜索，希望找到官方的代码（其实这部分通过逆向Android app相信就能得到，不过说好的剑走偏锋么）</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-644afb4717643723d463f2ee9db47acdf0c43852.jpeg" alt="img"></p>
<p>然后呢？duang～</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-35556fa64838b6ac201e212817f10760b2f9243e.jpeg" alt="img"></p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-a797fe2fc11e7bbd096f447b391627524ecbea86.jpeg" alt="img"></p>
<p>似乎是个第三方SDK，目前至少不用去逆向Android APP了开心，说实话这个我还真不擅长。通过这个SDK我找到了具体认证流程的代码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pangliang/miband-sdk-android/blob/cdb9bd038644ae3fb218a309bd20bf6520a8d035/miband-sdk/src/main/java/com/zhaoxiaodan/miband/model/UserInfo.java">GitHub - miband-sdk-android</a></p>
<p>从这段代码中分析，最终写入Characteristic的内容，来自 userInfo.getBytes(device.getAddress())</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserInfo</span><span class="params">(UserInfo userInfo)</span> &#123;</span><br><span class="line">    <span class="type">BluetoothDevice</span> <span class="variable">device</span> <span class="operator">=</span> <span class="built_in">this</span>.io.getDevice();</span><br><span class="line">    <span class="built_in">this</span>.io.writeCharacteristic(Profile.UUID_CHAR_USER_INFO, userInfo.getBytes(device.getAddress()), <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>userInfo.getBytes 的设计在这里，做了简单注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getBytes(String mBTAddress) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">bf</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">20</span>);</span><br><span class="line">    bf.put((<span class="type">byte</span>)(uid &amp; <span class="number">0xff</span>)); <span class="comment">//uid</span></span><br><span class="line">    bf.put((<span class="type">byte</span>)(uid &gt;&gt; <span class="number">8</span> &amp; <span class="number">0xff</span>));</span><br><span class="line">    bf.put((<span class="type">byte</span>)(uid &gt;&gt; <span class="number">16</span> &amp; <span class="number">0xff</span>));</span><br><span class="line">    bf.put((<span class="type">byte</span>)(uid &gt;&gt; <span class="number">24</span> &amp; <span class="number">0xff</span>));</span><br><span class="line">    bf.put(<span class="built_in">this</span>.gender); <span class="comment">//性别</span></span><br><span class="line">    bf.put(<span class="built_in">this</span>.age); <span class="comment">//年龄</span></span><br><span class="line">    bf.put(<span class="built_in">this</span>.height); <span class="comment">//身高</span></span><br><span class="line">    bf.put(<span class="built_in">this</span>.weight); <span class="comment">//体重</span></span><br><span class="line">    bf.put(<span class="built_in">this</span>.type); <span class="comment">//类型</span></span><br><span class="line">    <span class="keyword">if</span> (aliasBytes.length &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">        bf.put(aliasBytes);</span><br><span class="line">        bf.put(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span> - aliasBytes.length]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bf.put(aliasBytes, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">byte</span>[] crcSequence = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">19</span>]; <span class="comment">//取出用户信息的前19个字节</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">u</span> <span class="operator">=</span> <span class="number">0</span>; u &lt; crcSequence.length; u++)</span><br><span class="line">        crcSequence[u] = bf.array()[u];</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span> <span class="variable">crcb</span> <span class="operator">=</span> (<span class="type">byte</span>)((getCRC8(crcSequence) ^ Integer.parseInt(mBTAddress.substring(mBTAddress.length() - <span class="number">2</span>), <span class="number">16</span>)) &amp; <span class="number">0xff</span>);</span><br><span class="line">    bf.put(crcb); <span class="comment">//将签名跟前面的用户信息拼接</span></span><br><span class="line">    <span class="keyword">return</span> bf.array(); <span class="comment">//最终写入Characteristic的内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>UID</th>
<th>性别</th>
<th>身高&amp;体重</th>
<th>昵称第1byte凑齐19byte</th>
<th>MAC最后2byte</th>
</tr>
</thead>
<tbody><tr>
<td>dcxxxx00</td>
<td>0100</td>
<td>af3a00</td>
<td>6</td>
<td>FC</td>
</tr>
</tbody></table>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-43c611880386febef0276bcd77eef2d42d951b89.jpeg" alt="img"></p>
<p>完整代码也不放出了，毕竟可以秒杀手环认证：）</p>
<p>解决了认证的难题，接下来就是压轴大戏，如何对用户以及产品口碑造成真正的影响。震动？改步数？LED跑马灯？都不是，<strong>我选择在茫茫人群中，给你写入恶意的闹铃，名曰 午夜凶“铃”</strong>。试想下，背着我那台无线Hack设备，天天在早高峰蹭北京城铁13号线，自动搜索身边小米手环，然后链接过认证写入闹铃，你们猜一个月后我能“感染”多少手环？我相信不用多久，小米手环论坛就会有用户闹翻天了…光说不练耍流氓，实现它。选择设备后抓包，客户端设置几次闹铃，只要一次我就解开私有协议格式了：</p>
<p><img data-src="https://blog2021-1256870184.cos.ap-beijing.myqcloud.com/2021-09-05-4e131dca1cfcc3b82b42c1542175ae1a8fb29c95.jpeg" alt="img"></p>
<p>一样简单，数据格式我画出来。第一位说明当前的操作是闹铃，第二位是闹铃的序号，第三位闹铃的开关，第四位开始就是闹铃时间，倒数第二位是智能唤醒（就是在你浅睡眠的时候把你叫起，但是我偏不，就是要在你深度睡眠时唤醒你，木哈哈），最后一位就是闹铃的循环日期，0x7F就是每天。</p>
<p>写好测试程序，搜索并链接手环通过那个“认证”获取操作权限，再用手环LED玩个跑马灯，最后华丽丽的写入闹铃释放链接。<strong>结果手机客户端连上去发现闹！铃！没！开！启！还是默认的关闭状态</strong>，不放弃继续分析，我是越挫越勇的……</p>
<p>通过后面的分析发现，这个地方是小米手环客户端（至少iOS客户端）的BUG，手环开发组GG认为手环的数据只有通过客户端进行开启修改，所以非客户端写入的数据不会自动同步！也就造成了恶意闹铃虽然写入成功，但客户端看不到，认为闹铃没有变化不去同步最新的状态，但这反让攻击变的更加隐蔽了，啧啧。</p>
<p>看演示吧，POC代码不放，因为细心动手的人可以通过我的分析解决一切问题，也避免真的有人直接利用代码对小米用户进行攻击（因测试成功后忘记取消之前设置的午夜凶“铃”，所以我成了第一个受害者，大半夜太酸爽了）。</p>
<h2 id="0x05-结语"><a href="#0x05-结语" class="headerlink" title="0x05 结语"></a>0x05 结语</h2><p>内容没有涉及任何经典&#x2F;低功耗蓝牙的协议加解密、签名、配对儿认证等安全机制，毕竟是初探，不搞那么复杂高大上变成学术文章。所以我先分享一些接地气儿的产品和攻击场景，希望能够建立伙伴们对物联网安全的兴趣。</p>
<p>BLE在蓝牙中都是很小的一部分，在物联网汪洋大海中更是一叶扁舟，学海无涯希望路上有你。</p>
<blockquote>
<p>PS：以上的内容我个人认为并不是漏洞，毕竟还得10米的攻击范围内，所以直接当做技术分享吧。</p>
</blockquote>
<h2 id="0x06-参考资料"><a href="#0x06-参考资料" class="headerlink" title="0x06 参考资料"></a>0x06 参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.bluetooth.org/en-us/specification/adopted-specifications">Bluetooth® Core Specification 4.2</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nordicsemi.com/eng/nordic/download_resource/31919/6/98796976">nRF Sniffer User Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nordicsemi.com/eng/nordic/download_resource/31920/14/93837379">nRF-Sniffer-Code</a></li>
<li><a target="_blank" rel="noopener" href="http://product.dangdang.com/23502175.html">低功耗蓝牙开发指南 作者:（英）海登 著，陈灿峰　刘嘉　译</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/ooakk/article/details/7302425">CC2540 Bluetooth Low Energy Software Developer’s Guide (部分翻译修改版)</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>d4rk30
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.nohacker.me/2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/" title="【转载】物联网安全拔“牙”实战——低功耗蓝牙（BLE）初探">https://www.nohacker.me/2019/04/03/zhuan-zai-wu-lian-wang-an-quan-ba-ya-shi-zhan-di-gong-hao-lan-ya-ble-chu-tan/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/03/22/shi-yong-rtl-sdr-jie-shou-fei-ji-xin-hao/" rel="prev" title="使用RTL-SDR接收飞机信号">
                  <i class="fa fa-angle-left"></i> 使用RTL-SDR接收飞机信号
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/04/18/hackrf-jiao-cheng-yi/" rel="next" title="HackRF教程（一）">
                  HackRF教程（一） <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">d4rk30</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"d4rk30","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
